<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="Content-Language" content="zh-cn" />
    <link rel="icon" href="../favicon.ico" type="image/x-icon" />
    <style>
        body, h1, h2, p, ul {
            padding: 0;
            margin: 0;
            border: 0;
        }
        a {
            text-decoration: none;
        }
        body {
            font-family: Arial, Helvetica, sans-serif;
        }
        h1, h2 {
            font-size: 1.3em;
        }
        #wrapper {
            margin: auto;
            min-width: 1000px;
        }
        #header img {
            width: 100%;
            vertical-align: bottom;
        }
        #navfirst {
            text-align: center;
            background-color: #36b;
        }
        #navfirst ul {
            padding-right: 5%;
            float: right;
        }
        #navfirst ul li {
            display: inline;
            float: left;
            list-style: none;
        }
        #navfirst ul li a {
            display: block;
            padding: 0.5em 0.5em 0.3em 0.5em;
            text-decoration: initial;
            color: white;
        }
        #content {
            background-color: #29c;
            border-left: 3px solid #888;
        }
        #navsecond {
            border-top: 2px solid #29c;
            float: left;
            min-width: 190px;
            max-width: 20%;
            width: 20%;
        }
        #searchtext {
             width: 140px;
        }
        #navsecond li {
            margin-left: 20px;
            border-bottom: 1px solid white;
            list-style: none;
        }
        #navsecond a {
            color: white;
        }
        #navsecond h1 {
            margin: 0 0 10px 0;
            background-color: #36a;
        }
        #navsecond ul, #search {
            margin: 10px 0;
        }
        #maincontent {
            float: right;
            min-width: 790px;
            max-width: 79%;
            width: 79%;
            background-color: white;
        }
        #datastatus {
            text-align: center;
        }
        #datainfo {
            display: inline;
        }
        #response div {
            float: left;
            margin-left: 1px;
            text-align: center;
            font-weight: bold;
        }
        #response tbody {
            text-align: left;
            font-weight: normal;
        }
        #copyright {
            margin: 0 auto 27px auto;
            text-align: center;
        }
        tr.count {
            background-color: #9cf;
        }
        tr.onshelf {
            background-color: #3f6;
        }
        tr.ordered {
            background-color: #fc6;
        }
        tr.borrowed {
            background-color: #f88;
        }
        tr.today {
            background-color: #f73;
        }
        tr.overdue {
            background-color: #f00;
        }
        tr.repairing {
            background-color: #ccc;
        }
        tr.intransit {
            background-color: #88f;
        }
        td.status {
            max-width: 80px;
            overflow: hidden;
        }
        tbody td {
            font-size: 0.7em;
        }
        .clear {
            clear: both;
        }
    </style>
    <script type="text/javascript">
        var iPadCount; //iPad总数
        /**
         * 初始化<br>
         * 先按iPad序号排序<br>
         * 再按状态类型和归还日期排序
         */
        function i() {
            iPadCount = iPadStatus.length;
            document.getElementById("datainfo").innerHTML = reStat;
            sort0();
            sort1();
            g("E0");
        }
        /**
         * 刷新数据
         */
        function r() {
            var script = document.createElement("script");
            script.setAttribute("src", "ipadstatus.php?t=" + new Date().getTime());
            document.getElementsByTagName("head")[0].appendChild(script);
        }
        /**
         * 按iPad序号排序
         */
        function sort0() {
            // 选择排序
            var tmp;
            var minIndex;
            for (var i = 0; i < iPadCount; ++i) {
                minIndex = i;
                for (var j = i; j < iPadCount; ++j)
                    if (iPadStatus[j].id < iPadStatus[minIndex].id)
                        minIndex = j;
                tmp = iPadStatus[i];
                iPadStatus[i] = iPadStatus[minIndex];
                iPadStatus[minIndex] = tmp;
            }
        }
        /**
         * 按状态类型和归还日期从小到大排序<br>
         * 不改变同种状态的iPad的序号顺序
         */
        function sort1() {
            // 冒泡排序
            var tmp;
            for (var i = iPadCount - 1; i >= 0; --i)
                for (var j = 0; j < i; ++j)
                    if (iPadStatus[j].status > iPadStatus[j + 1].status) {
                        tmp = iPadStatus[j];
                        iPadStatus[j] = iPadStatus[j + 1];
                        iPadStatus[j + 1] = tmp;
                    }
        }
        /**
         * 按地点从iLibrary到PBL排序<br>
         * 不改变同种状态的iPad的序号顺序
         */
        function sort2() {
            // 冒泡排序
            var tmp;
            for (var i = iPadCount - 1; i >= 0; --i)
                for (var j = 0; j < i; ++j)
                    if (iPadStatus[j].site.toLowerCase() > iPadStatus[j + 1].site.toLowerCase()) {
                        tmp = iPadStatus[j];
                        iPadStatus[j] = iPadStatus[j + 1];
                        iPadStatus[j + 1] = tmp;
                    }
        }
        /**
         * 生成iPad状态的表格
         *
         * @param indexs
         *            所有添加的iPadStatus的index
         *
         * @param title
         *            表格标题
         *
         * @return 被div括起的带标题的indexs对应的iPad状态的表格
         */
        function makeTable(indexs, title) {
            /**
             * 获取表格某行的类名
             *
             * @param status
             *            状态
             *
             * @return 状态对应的类名
             */
            var getTrClass = function (status) {
                if (status.search("在架上") >= 0) {
                    return "onshelf";
                } else if (status.search("在预约架上") >= 0) {
                    return "ordered";
                } else if (status.search("到期") >= 0) {
                    var matches;
                    if (matches = status.match(/(\S+)\s(\d+-\d+-\d+)/)) {
                        var remaining = Date.parse("20" + matches[2] + " 21:30") - new Date().getTime();
                        if (remaining < 0)
                            return "overdue";
                        else if (remaining < 77400000)
                            return "today";
                    }
                    return "borrowed";
                } else if (status.search("修补中") >= 0) {
                    return "repairing";
                } else if (status.search("IN TRANSIT") >= 0) {
                    return "intransit";
                } else {
                    return "other";
                }
            }
            var count = 0;
            var re = "";
            tbody = "";
            for (var i = 0; i < indexs.length; ++i) {
                var iPadStatusI = iPadStatus[indexs[i]];
                var trClass = getTrClass(iPadStatusI.status);
                var isOnShelf = (trClass == "onshelf");
                tbody += "<tr class='" + trClass + "'><td>" + iPadStatusI.site + "</td><td>";
                if (isOnShelf)
                    tbody += iPadStatusI.id;
                else
                    tbody += "<a href='http://innopac.lib.xjtu.edu.cn/search~S3*chx?/c//,,,/request&b" + iPadStatusI.id.toLowerCase() + "' target='_blank'>" + iPadStatusI.id + "</a>";
                tbody += "</td><td class='status'>" + iPadStatusI.status + "</td></tr>";
                ++count;
            }
            return re + "<div><p>" + (title || "") + "</p><table border='1' cellspacing='1' cellpadding='0'><thead><tr class='count'><td>共有</td><td>" + count + "</td><td>条记录</td></tr><tr><td>类别</td><td>条码</td><td>状态</td></tr></thead><tbody>" + tbody + "</tbody><tfoot><tr class='count'><td>共有</td><td>" + count + "</td><td>条记录</td></tr></tfoot></table></div>";
        }
        /**
         * 搜索符合正则表达式的iPad信息
         *
         * @param idRegEx
         *            索书号正则表达式
         *
         * @param siteRegEx
         *            位置正则表达式
         *
         * @param statusRegEx
         *            状态正则表达式
         *
         * @param title
         *            表格标题
         *
         * @return 被div括起的标题和符合的iPad信息table
         */
        function getMatch(idRegEx, siteRegEx, statusRegEx, title) {
            var indexs = new Array();
            for (var i = 0; i < iPadCount; ++i) {
                var iPadStatusI = iPadStatus[i];
                if (iPadStatusI.id.search(new RegExp(idRegEx, "i")) >= 0
                        && iPadStatusI.site.search(new RegExp(siteRegEx, "i")) >= 0
                        && iPadStatusI.status.search(new RegExp(statusRegEx, "i")) >= 0) {
                    indexs.push(i);
                }
            }
            return makeTable(indexs, title || idRegEx + " " + siteRegEx + " " + statusRegEx);
        }
        /**
         * 模糊搜索符合正则表达式的iPad信息
         *
         * @param regEx
         *            模糊匹配的正则表达式
         *
         * @param title
         *            表格标题
         *
         * @return 被div括起的标题和符合的iPad信息table
         */
        function getFuzzyMatch(regEx, title) {
            var indexs = new Array();
            for (var i = 0; i < iPadCount; ++i) {
                var iPadStatusI = iPadStatus[i];
                if ((iPadStatusI.site + iPadStatusI.id + iPadStatusI.status).search(new RegExp(regEx, "i")) >= 0) {
                    indexs.push(i);
                }
            }
            return makeTable(indexs, title || regEx);
        }
        /**
         * 清空回应div
         */
        function clearInnerHTML() {
            document.getElementById("response").innerHTML = "";
        }
        /**
         * 向回应div添加内容
         *
         * @param html
         *            要添加的html代码
         */
        function appendInnerHTML(html) {
            document.getElementById("response").innerHTML += html;
        }
        /**
         * 向div中添加状态表格
         *
         * @param type
         *            查询的类别码<br>
         *            A表示iPad<br>
         *            B表示iPad mini<br>
         *            C表示PBL<br>
         *            D表示iMac<br>
         *            1表示在架上/在预约架上<br>
         *            2表示已借出<br>
         *            3表示修补中<br>
         *            4表示IN TRANSIT<br>
         *            0表示所有<br>
         *            没有第二位表示以上5种<br>
         *            D表示所有<br>
         *            E0表示常用<br>
         *            E1表示全部iPad<br>
         *            E2表示以上11种
         *
         * @param type
         *            是否清除回应div
         */
        function getStatus(type, isClear) {
            if (isClear)
                clearInnerHTML();
            var idRegEx, siteRegEx, statusRegEx, title;
            idRegEx = "";
            siteRegEx = "";
            title = "";
            var letter = type.substr(0, 1);
            switch(letter) {
                case "A":
                case "B":
                case "C":
                case "D":
                    switch(letter) {
                        case "A":
                            siteRegEx = "IPAD";
                            title = "iPad";
                            break;
                        case "B":
                            siteRegEx = "MINI";
                            title = "mini";
                            break;
                        case "C":
                            siteRegEx = "PBL";
                            title = "PBL";
                            break;
                        case "D":
                            siteRegEx = "IMAC";
                            title = "iMac";
                            break;
                    }
                    if(type.length > 1) {
                        letter = type.substr(1, 1);
                        switch(letter) {
                            case "0":
                                statusRegEx = "";
                                break;
                            case "1":
                                statusRegEx = "(在架上)|(在预约架上)";
                                title += " 在架上";
                                break;
                            case "2":
                                statusRegEx = "到期";
                                title += " 已借出";
                                break;
                            case "3":
                                statusRegEx = "修补中";
                                title += " 修补中"
                                break;
                            case "4":
                                statusRegEx = "IN TRANSIT";
                                title += " IN TRANSIT"
                                break;
                        }
                        appendInnerHTML(getMatch(idRegEx, siteRegEx, statusRegEx, title));
                    } else {
                        getStatus(letter + "1", false);
                        getStatus(letter + "2", false);
                        getStatus(letter + "3", false);
                        getStatus(letter + "4", false);
                        getStatus(letter + "0", false);
                    }
                    break;
                case "E":
                    letter = type.substr(1, 1);
                    switch(letter) {
                        case "0":
                            getStatus('A1', false);
                            getStatus('B1', false);
                            getStatus('A2', false);
                            getStatus('B2', false);
                            break;
                        case "1":
                            sort2();
                            appendInnerHTML(getMatch("", "", "", "全部iPad(按分类排序)"));
                            sort0();
                            appendInnerHTML(getMatch("", "", "", "全部iPad(按序号排序)"));
                            sort1();
                            break;
                        case "2":
                            getStatus("A", false);
                            appendInnerHTML("<br />");
                            getStatus("B", false);
                            appendInnerHTML("<br />");
                            getStatus("C", false);
                            appendInnerHTML("<br />");
                            getStatus("D0", false);
                            appendInnerHTML("<br />");
                            getStatus("E1", false);
                            break;
                    }
                    break;
            }
        }
        /**
         * 动画效果
         */
        function slide(f) {
            if (!window.jQuery) {
                f();
            } else {
                $("#response").slideUp("", function () {
                    f();
                    $("body").animate({scrollTop: $("#navfirst").offset().top}, 500);
                    $("#response").slideDown();
                }); 
            }
        }
        /**
         * 封装的后的搜索
         */
        function s() {
            /**
             * 搜索指定文本
             */
            var doSearch = function () {
                var searchtext = document.getElementById("searchtext").value;
                sort2();
                clearInnerHTML();
                appendInnerHTML(getFuzzyMatch(searchtext, "模糊搜索：" + searchtext));
                sort1();
            }
            slide(doSearch);
        }
        /**
         * 封装的后的获取状态
         */
        function g(type) {
            slide(function () {getStatus(type, true);});
        }
    </script>   
    <script type="text/javascript" src="http://www.xjtu.edu.cn/js/jquery.js"></script>
    <title>iPad状态</title>
</head>
<body onload="r();">
    <div id="wrapper">
        <div id="header">
            <a href="http://www.lib.xjtu.edu.cn/"><img src="http://www.lib.xjtu.edu.cn/image/banner.png"></a>
        </div>
        <div id="navfirst">
            <ul>
                <li><a href="http://www.xjtu.edu.cn">西安交通大学主页</a></li>
                <li><a href="http://www.lib.xjtu.edu.cn">图书馆主页</a></li>
                <li><a href="http://www.lib.xjtu.edu.cn/custom.do?id=385" target="_blank">iLibrary Space预约</a></li>
                <li><a href="http://innopac.lib.xjtu.edu.cn/patroninfo*chx">个人借阅查询</a></li>
                <li><a href="./">iPad状态</a></li>
            </ul>
            <div class="clear"></div>
        </div>
        <div id="content">
            <div id="navsecond">
                <h1>iPad搜索</h1>
                <div id="search">
                    <input id="searchtext" onkeypress="if (13 == event.keyCode) s();"/>
                    <input onclick="s();" type="button" value="搜索" />
                </div>
                <h1>常用：</h1>
                <ul>
                    <li><a href="javascript:g('E0');">常用</li>
                    <li><a href="javascript:g('A1');">iPad 在架上</a></li>
                    <li><a href="javascript:g('B1');">mini 在架上</a></li>
                </ul>
                <h1>iLibrary：</h1>
                <h2>iPad2：</h2>
                <ul>
                    <li><a href="javascript:g('A1');">在架上/在预约架上</a></li>
                    <li><a href="javascript:g('A2');">已借出</a></li>
                    <li><a href="javascript:g('A3');">修补中</a></li>
                    <li><a href="javascript:g('A4');">IN TRANSIT</a></li>
                    <li><a href="javascript:g('A0');">所有</a></li>
                    <li><a href="javascript:g('A');">以上5种</a></li>
                </ul>
                <h2>iPad mini2：</h2>
                <ul>
                    <li><a href="javascript:g('B1');">在架上/在预约架上</a></li>
                    <li><a href="javascript:g('B2');">已借出</a></li>
                    <li><a href="javascript:g('B3');">修补中</a></li>
                    <li><a href="javascript:g('B4');">IN TRANSIT</a></li>
                    <li><a href="javascript:g('B0');">所有</a></li>
                    <li><a href="javascript:g('B');">以上5种</a></li>
                </ul>
                <h2>iMac：</h2>
                <ul>
                    <li><a href="javascript:g('D0');">所有</a></li>
                </ul>
                <h1>PBL：</h1>
                <ul>
                    <li><a href="javascript:g('C1');">在架上/在预约架上</a></li>
                    <li><a href="javascript:g('C2');">已借出</a></li>
                    <li><a href="javascript:g('C3');">修补中</a></li>
                    <li><a href="javascript:g('C4');">IN TRANSIT</a></li>
                    <li><a href="javascript:g('C0');">所有</a></li>
                    <li><a href="javascript:g('C');">以上5种</a></li>
                </ul>
                <h1>全部：</h1>
                <ul>
                    <li><a href="javascript:g('E0');">常用</a></li>
                    <li><a href="javascript:g('E1');">全部</a></li>
                    <li><a href="javascript:g('E2');">以上17种</a></li>
                </ul>
                <h1>常用链接</h1>
                <ul>
                    <li><a href="http://innopac.lib.xjtu.edu.cn/search~S3*chx?/c//,,,/holdings&bipad" target="_blank">查看1-25,36-40</a></li>
                    <li><a href="http://innopac.lib.xjtu.edu.cn/search~S3*chx?/c//,,,/holdings&bipad0083" target="_blank">查看26-35,41-83</a></li>
                    <li><a href="http://innopac.lib.xjtu.edu.cn/search~S3*chx?/c//,,,/holdings&bmini" target="_blank">查看mini1-53</a></li>
                    <li><a href="http://innopac.lib.xjtu.edu.cn/search~S3*chx?/c//,,,/holdings&bmini0057" target="_blank">查看mini54-57</a></li>
                    <li><a href="http://innopac.lib.xjtu.edu.cn/search~S3*chx?/c//,,,/holdings&bimac" target="_blank">查看iMac</a></li>
                    <li><a href="http://innopac.lib.xjtu.edu.cn/search~S3*chx?/c//,,,/request&bipad" target="_blank">预约1-25,36-40</a></li>
                    <li><a href="http://innopac.lib.xjtu.edu.cn/search~S3*chx?/c//,,,/request&bipad0083" target="_blank">预约26-35,41-83</a></li>
                    <li><a href="http://innopac.lib.xjtu.edu.cn/search~S3*chx?/c//,,,/request&bmini" target="_blank">预约mini1-53</a></li>
                    <li><a href="http://innopac.lib.xjtu.edu.cn/search~S3*chx?/c//,,,/request&bmini0057" target="_blank">预约mini54-57</a></li>
                </ul>
            </div>
            <div id="maincontent">
                <div id="datastatus">
                    <div id="datainfo">加载中......</div>
                    <input onclick="r();" type="button" value="刷新" />
                </div>
                <div id="response"></div>
            </div>
            <div class="clear"></div>
        </div>
        <hr />
        <div id="footer">
            <p id="copyright">eeyes.net&copy;2002-2016</p>
        </div>
    </div>
</body>
</html>